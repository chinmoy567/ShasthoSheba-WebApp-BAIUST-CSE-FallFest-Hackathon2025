<%- include("../partials/head") %> 
<%- include("../partials/navbar") %>

<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-indigo-900 min-h-screen text-gray-100 font-sans flex flex-col">
  <div
    class="flex flex-col max-w-4xl w-full mx-auto mt-8 bg-blue-800/50 backdrop-blur-sm rounded-2xl flex-grow overflow-hidden card-shadow border border-blue-600/30"
  >
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 text-center py-4 text-2xl font-bold tracking-wide"
    >
      üé§ ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶® <span class="text-gray-800">‡¶Æ‡¶®‡ßã‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá</span>
    </header>

    <!-- Chat Box -->
    <main
      id="chatBox"
      class="flex-1 overflow-y-auto p-6 space-y-4 bg-blue-900/30 scroll-smooth"
    ></main>

    <!-- Footer -->
    <footer
      class="border-t border-blue-600/30 p-4 flex flex-col items-center bg-blue-800/50"
    >
      <button
        id="recordBtn"
        class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 font-bold px-6 py-3 rounded-xl shadow transition duration-200 transform hover:scale-105 card-shadow border border-yellow-400"
      >
        üéô ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶¶‡¶ø‡ßü‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶®
      </button>
      <audio
        id="aiAudio"
        controls
        class="hidden mt-3 w-11/12 rounded-lg"
      ></audio>
    </footer>
  </div>

  <script>
    let history = [];
    const chatBox = document.getElementById("chatBox");
    const aiAudio = document.getElementById("aiAudio");
    const btn = document.getElementById("recordBtn");

    function appendMessage(role, text) {
      const wrapper = document.createElement("div");
      wrapper.classList.add("flex", "items-start", "gap-3", "animate-fadeIn");

      const isUser = role === "user";
      wrapper.innerHTML = isUser
        ? `
        <div class="flex justify-end w-full">
          <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 px-4 py-3 rounded-2xl rounded-br-sm max-w-[80%] shadow-md">
            ${text}
          </div>
          <span class="text-2xl ml-2">üë§</span>
        </div>`
        : `
        <div class="flex items-start w-full">
          <span class="text-2xl mr-2">ü§ñ</span>
          <div class="bg-blue-700/50 text-blue-100 px-4 py-3 rounded-2xl rounded-bl-sm max-w-[80%] shadow-sm border border-blue-600/30">
            ${text}
          </div>
        </div>`;

      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTyping() {
      const typingDiv = document.createElement("div");
      typingDiv.classList.add("flex", "items-start", "gap-3", "typing");
      typingDiv.innerHTML = `
        <span class="text-2xl">ü§ñ</span>
        <div class="flex space-x-1 bg-blue-700/50 rounded-full px-3 py-2 border border-blue-600/30">
          <span class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce"></span>
          <span class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce delay-150"></span>
          <span class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce delay-300"></span>
        </div>`;
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return typingDiv;
    }

    btn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          channelCount: 1,
          sampleRate: 44100,
          noiseSuppression: true,
          echoCancellation: true,
        },
      });

      const recorder = new MediaRecorder(stream, {
        mimeType: "audio/webm;codecs=opus",
        audioBitsPerSecond: 128000,
      });

      const chunks = [];
      btn.innerText = "üéô ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
      btn.classList.add("bg-gradient-to-r", "from-red-500", "to-red-600");
      recorder.ondataavailable = (e) => chunks.push(e.data);

      recorder.onstop = async () => {
        btn.innerText = "üé§ ‡¶¨‡¶≤‡ßÅ‡¶®";
        btn.classList.remove("bg-gradient-to-r", "from-red-500", "to-red-600");

        const blob = new Blob(chunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob, "voice.webm");
        formData.append("userId", "<%= user._id %>");
        formData.append("history", JSON.stringify(history));

        appendMessage("user", "üéß ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≠‡ßü‡ßá‡¶∏ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ‡¶ú‡¶æ‡¶§ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
        const typingDiv = showTyping();

        const res = await fetch("/dashboard/voice/chat", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        chatBox.removeChild(typingDiv);
        chatBox.lastChild.remove();

        appendMessage("user", data.userSpeech || "‡¶∂‡¶¨‡ßç‡¶¶ ‡¶ß‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
        appendMessage(
          "assistant",
          data.aiText || "‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø, ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶≤‡¶¨‡ßá‡¶®?"
        );

        history.push({ role: "user", content: data.userSpeech });
        history.push({ role: "assistant", content: data.aiText });

        if (data.audio) {
          const src = `data:audio/mp3;base64,${data.audio}`;
          aiAudio.src = src;
          aiAudio.classList.remove("hidden");
          aiAudio.play();
        }
      };

      recorder.start();
      setTimeout(() => recorder.stop(), 5000);
    };
  </script>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }
    .delay-150 {
      animation-delay: 0.15s;
    }
    .delay-300 {
      animation-delay: 0.3s;
    }
    .card-shadow { 
      box-shadow: 0 12px 30px rgba(14, 12, 26, 0.5); 
    }
  </style>
</body>
